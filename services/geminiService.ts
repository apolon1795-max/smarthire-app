
import { TestResult, CandidateInfo, CustomTestConfig } from "../types";

// –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è URL —Å–∫—Ä–∏–ø—Ç–∞
export const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEsHd6tfjTlNqBHERiJ_dUQgk9YOBntn2aD94eEUzy-MjN2FPPgTwkDzTSCy-_9p7k/exec';

const callBackendAI = async (prompt: string, jsonMode: boolean = false): Promise<string> => {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action: 'GENERATE_AI',
        prompt: prompt,
        jsonMode: jsonMode
      })
    });
    
    const text = await response.text();
    
    if (text.trim().startsWith('<')) {
        throw new Error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∫—Ä–∏–ø—Ç—É Google. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Deployment.");
    }

    const data = JSON.parse(text);
    if (data.status === 'success') {
      return data.text;
    } else {
      throw new Error(data.message || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
    }
  } catch (error: any) {
    throw new Error(error.message || "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
};

export const generateCandidateProfile = async (results: TestResult[], candidateInfo?: CandidateInfo): Promise<string> => {
  const resultsText = results.map(r => {
    let details = '';
    if (r.sectionId === 'conscientiousness') {
       details = ` (HEXACO: ${r.hexacoProfile?.map(h => `${h.code}=${h.average}`).join(', ')})`;
    }
    if (r.sectionId === 'motivation') {
       details = ` (Drivers: ${r.motivationProfile?.topDrivers.map(d => d.name).join(', ')})`;
    }
    return `- ${r.title}: ${r.percentage.toFixed(0)}%${details}`;
  }).join('\n');

  const prompt = `
    –†–æ–ª—å: –°—Ç–∞—Ä—à–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ—Ü–µ–Ω–∫–µ —Ç–∞–ª–∞–Ω—Ç–æ–≤ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥.
    –ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.
    –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π (–°—Ç—Ä–æ–≥–∏–π –±–∏–∑–Ω–µ—Å-—Å—Ç–∏–ª—å).
    –ö–∞–Ω–¥–∏–¥–∞—Ç: ${candidateInfo?.name || "–ö–∞–Ω–¥–∏–¥–∞—Ç"}, –í–∞–∫–∞–Ω—Å–∏—è: ${candidateInfo?.role || "–°–æ–∏—Å–∫–∞—Ç–µ–ª—å"}.
    
    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
    ${resultsText}
    
    –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
    1. –ì–ª—É–±–æ–∫–∏–π —Å–∏–Ω—Ç–µ–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π —Ü–∏—Ñ—Ä—ã, –∞ –¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏.
    2. –ò—Å–ø–æ–ª—å–∑—É–π HTML: <h3> –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, <b> –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤, <ul>/<li> –¥–ª—è —Å–ø–∏—Å–∫–æ–≤.
    3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
       <h3>üí° –†–µ–∑—é–º–µ –∏ –ü—Ä–æ–≥–Ω–æ–∑</h3> - –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–æ–¥ —Ä–æ–ª—å? –ö–∞–∫–æ–≤ –µ–≥–æ —Å—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã?
       <h3>üöÄ –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏</h3> - –ß—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç –ª—É—á—à–µ –¥—Ä—É–≥–∏—Ö?
       <h3>‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</h3> - –í –∫–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö –æ–Ω –º–æ–∂–µ—Ç "—Å–ª–æ–º–∞—Ç—å—Å—è" –∏–ª–∏ –ø–æ—Ç–µ—Ä—è—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?
    
    –í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML. –ë–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏ markdown (–Ω–∏–∫–∞–∫–∏—Ö \`\`\`html).
  `;

  try {
    return await callBackendAI(prompt, false);
  } catch (e: any) {
    return `<div style='color:#f87171;'>–û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: ${e.message}</div>`;
  }
};

export const generateCustomQuestions = async (jobRole: string, challenges: string): Promise<CustomTestConfig | null> => {
  const prompt = `
    –†–æ–ª—å: –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–º–µ—Ç–æ–¥–æ–ª–æ–≥ –ø–æ –æ—Ü–µ–Ω–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ (Assessment Center) –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∫–µ–π—Å-–∏–Ω—Ç–µ—Ä–≤—å—é. –¢–≤–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –≥–ª—É–±–æ–∫–∏—Ö, –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.
    –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π (–°—Ç—Ä–æ–≥–∏–π –±–∏–∑–Ω–µ—Å-—Å—Ç–∏–ª—å).

    –í–í–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
    –í–∞–∫–∞–Ω—Å–∏—è: "${jobRole}"
    –ü—Ä–æ–±–ª–µ–º—ã –∏ –≤—ã–∑–æ–≤—ã (Context): "${challenges}"

    –¢–í–û–Ø –ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –∏–∑ –¥–≤—É—Ö —Ä–∞–∑–¥–µ–ª–æ–≤.

    –ó–ê–î–ê–ù–ò–ï ‚Ññ1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SJT (Situational Judgment Test) ‚Äî 4 —Å–∏—Ç—É–∞—Ü–∏–∏.
    - –¢–µ–º–∞—Ç–∏–∫–∞: –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∫–∞—Å–∞—Ç—å—Å—è –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û Soft Skills (–º–µ–∂–ª–∏—á–Ω–æ—Å—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, —ç—Ç–∏—á–µ—Å–∫–∏–µ –¥–∏–ª–µ–º–º—ã, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è–º–∏ —Å—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä–æ–≤, –∫–æ–º–∞–Ω–¥–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞).
    - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ò—Å–∫–ª—é—á–∏ –æ—á–µ–≤–∏–¥–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã. –í—Å–µ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–∏–µ–º–ª–µ–º—ã–º–∏ –∏ –ª–æ–≥–∏—á–Ω—ã–º–∏, –Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç" vs "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π" vs "–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º").
    - –û–±—ä–µ–º: –û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–º (–º–∏–Ω–∏–º—É–º 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), —Å–æ–∑–¥–∞—é—â–∏–º —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –∏ –¥–∞–≤–ª–µ–Ω–∏—è (—Ü–µ–π—Ç–Ω–æ—Ç, —à—É–º, –Ω–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤).
    - –û—Ü–µ–Ω–∫–∞: 
      2 –±–∞–ª–ª–∞ ‚Äî –º—É–¥—Ä–æ–µ, —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.
      1 –±–∞–ª–ª ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ/–±—é—Ä–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º –∏–ª–∏ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.
      0 –±–∞–ª–ª–æ–≤ ‚Äî —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, —É—Å—Ç—É–ø–∫–∞ –≤ —É—â–µ—Ä–± –±–∏–∑–Ω–µ—Å—É –∏–ª–∏ –ø–∞—Å—Å–∏–≤–Ω–æ—Å—Ç—å.

    –ó–ê–î–ê–ù–ò–ï ‚Ññ2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Work Sample (–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ) ‚Äî 1 –æ–±—ä–µ–º–Ω—ã–π –∫–µ–π—Å.
    - –§–æ—Ä–º–∞—Ç: "In-Basket" (–í—Ö–æ–¥—è—â–∞—è –ø–æ—á—Ç–∞ / –ò–Ω—Ü–∏–¥–µ–Ω—Ç).
    - –¢–µ–º–∞—Ç–∏–∫–∞: –ó–∞–¥–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å Hard Skills (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–∞—Å—á–µ—Ç—ã, —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞).
    - –ê–ù–¢–ò-–î–£–ë–õ–¨: –¢–µ–º–∞ –∑–∞–¥–∞–Ω–∏—è –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å—Å—è —Å —Å–∏—Ç—É–∞—Ü–∏—è–º–∏ –∏–∑ SJT. –ù–∏–∫–∞–∫–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –∫–æ–ª–ª–µ–≥–∞–º–∏ ‚Äî —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞.
    - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—è "text" –¥–ª—è Work Sample:
      1. –õ–ï–ì–ï–ù–î–ê: –ü–æ–¥—Ä–æ–±–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ä–æ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –¥–∞—Ç—ã, –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞, –ø–∏—Å—å–º–æ –æ—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ –∂–∞–ª–æ–±–∞ –∫–ª–∏–µ–Ω—Ç–∞).
      2. –ú–ï–¢–†–ò–ö–ò –ò –¶–ò–§–†–´: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏ –≤ —É—Å–ª–æ–≤–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–±—é–¥–∂–µ—Ç—ã, KPI, —Å—Ä–æ–∫–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø–∞–¥–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤ –∏ —Ç.–¥.), –∫–æ—Ç–æ—Ä—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
      3. –ó–ê–î–ê–ß–ê (3 –≠–¢–ê–ü–ê): –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–¥–∞–Ω–∏–µ —Ç–∞–∫, —á—Ç–æ–±—ã –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã–ª —Å–¥–µ–ª–∞—Ç—å 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã. 2. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ "–∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å". 3. –°–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞ –±—É–¥—É—â–µ–µ).

    –§–û–†–ú–ê–¢ –í–´–î–ê–ß–ò (–°–¢–†–û–ì–û JSON):
    {
      "sjtQuestions": [
        {
          "id": "1",
          "text": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–∏–ª–µ–º–º—ã...",
          "type": "scenario",
          "options": [
            { "id": "a", "text": "–í–∞—Ä–∏–∞–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—è –ê...", "value": 2 },
            { "id": "b", "text": "–í–∞—Ä–∏–∞–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—è –ë...", "value": 1 },
            { "id": "c", "text": "–í–∞—Ä–∏–∞–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—è –í...", "value": 0 }
          ]
        },
        ... (–≤—Å–µ–≥–æ 4 –≤–æ–ø—Ä–æ—Å–∞)
      ],
      "workSampleQuestion": {
        "id": "ws1",
        "text": "–õ–ï–ì–ï–ù–î–ê:\\n...\\n\\n–ú–ï–¢–†–ò–ö–ò –ò –¶–ò–§–†–´:\\n...\\n\\n–ó–ê–î–ê–ß–ê (3 –≠–¢–ê–ü–ê):\\n1... 2... 3...",
        "type": "text"
      }
    }
    
    –í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –∫–æ–¥–æ–º. –ë–µ–∑ markdown —Ä–∞–∑–º–µ—Ç–∫–∏.
  `;
  
  try {
    const jsonString = await callBackendAI(prompt, true);
    const cleanJson = jsonString.replace(/```json/g, "").replace(/```/g, "").trim();
    return JSON.parse(cleanJson);
  } catch (error) {
    console.error("Custom Question Gen Error:", error);
    throw error;
  }
};

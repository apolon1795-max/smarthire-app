
import { TestResult, CandidateInfo, CustomTestConfig } from "../types";

// –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è URL —Å–∫—Ä–∏–ø—Ç–∞
export const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEsHd6tfjTlNqBHERiJ_dUQgk9YOBntn2aD94eEUzy-MjN2FPPgTwkDzTSCy-_9p7k/exec';

const callBackendAI = async (prompt: string, jsonMode: boolean = false): Promise<string> => {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action: 'GENERATE_AI',
        prompt: prompt,
        jsonMode: jsonMode
      })
    });
    
    const text = await response.text();
    
    if (text.trim().startsWith('<')) {
        throw new Error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∫—Ä–∏–ø—Ç—É Google. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Deployment.");
    }

    const data = JSON.parse(text);
    if (data.status === 'success') {
      return data.text;
    } else {
      throw new Error(data.message || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
    }
  } catch (error: any) {
    throw new Error(error.message || "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
};

export const generateCandidateProfile = async (results: TestResult[], candidateInfo?: CandidateInfo): Promise<string> => {
  const resultsText = results.map(r => {
    let details = '';
    if (r.sectionId === 'conscientiousness') {
       details = ` (HEXACO: ${r.hexacoProfile?.map(h => `${h.code}=${h.average}`).join(', ')})`;
    }
    if (r.sectionId === 'motivation') {
       details = ` (Drivers: ${r.motivationProfile?.topDrivers.map(d => d.name).join(', ')})`;
    }
    return `- ${r.title}: ${r.percentage.toFixed(0)}%${details}`;
  }).join('\n');

  const prompt = `
    –†–æ–ª—å: –°—Ç–∞—Ä—à–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ—Ü–µ–Ω–∫–µ —Ç–∞–ª–∞–Ω—Ç–æ–≤ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥.
    –ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.
    –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π (–°—Ç—Ä–æ–≥–∏–π –±–∏–∑–Ω–µ—Å-—Å—Ç–∏–ª—å).
    –ö–∞–Ω–¥–∏–¥–∞—Ç: ${candidateInfo?.name || "–ö–∞–Ω–¥–∏–¥–∞—Ç"}, –í–∞–∫–∞–Ω—Å–∏—è: ${candidateInfo?.role || "–°–æ–∏—Å–∫–∞—Ç–µ–ª—å"}.
    
    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
    ${resultsText}
    
    –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
    1. –ì–ª—É–±–æ–∫–∏–π —Å–∏–Ω—Ç–µ–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π —Ü–∏—Ñ—Ä—ã, –∞ –¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏.
    2. –ò—Å–ø–æ–ª—å–∑—É–π HTML: <h3> –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, <b> –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤, <ul>/<li> –¥–ª—è —Å–ø–∏—Å–∫–æ–≤.
    3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
       <h3>üí° –†–µ–∑—é–º–µ –∏ –ü—Ä–æ–≥–Ω–æ–∑</h3> - –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–æ–¥ —Ä–æ–ª—å? –ö–∞–∫–æ–≤ –µ–≥–æ —Å—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã?
       <h3>üöÄ –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏</h3> - –ß—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç –ª—É—á—à–µ –¥—Ä—É–≥–∏—Ö?
       <h3>‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</h3> - –í –∫–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö –æ–Ω –º–æ–∂–µ—Ç "—Å–ª–æ–º–∞—Ç—å—Å—è" –∏–ª–∏ –ø–æ—Ç–µ—Ä—è—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?
    
    –í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML. –ë–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏ markdown.
  `;

  try {
    return await callBackendAI(prompt, false);
  } catch (e: any) {
    return `<div style='color:#f87171;'>–û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: ${e.message}</div>`;
  }
};

export const generateCustomQuestions = async (jobRole: string, challenges: string): Promise<CustomTestConfig | null> => {
  const prompt = `
    –¢–´ - –í–ï–î–£–©–ò–ô –ê–†–•–ò–¢–ï–ö–¢–û–† –ê–°–°–ï–°–°–ú–ï–ù–¢-–¶–ï–ù–¢–†–û–í. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –ü–†–ï–î–ï–õ–¨–ù–û –°–õ–û–ñ–ù–´–ô —Ç–µ—Å—Ç –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ "${jobRole}". 
    –ó–∞–±—É–¥—å –ø—Ä–æ –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ù–∞–º –Ω—É–∂–Ω—ã –±–∏–∑–Ω–µ—Å-–∫–µ–π—Å—ã —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è.
    –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π (–î–µ–ª–æ–≤–æ–π). –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–∑–æ–≤–æ–≤: "${challenges}".

    *** –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï: –†–ê–ó–î–ï–õ–ï–ù–ò–ï –¢–ï–ú ***
    SJT-–≤–æ–ø—Ä–æ—Å—ã –∏ WORK SAMPLE –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –ê–ë–°–û–õ–Æ–¢–ù–û –†–ê–ó–ù–´–ï –¢–ï–ú–´.
    - –ï—Å–ª–∏ SJT –ø—Ä–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å –≥–æ—Å—Ç—è–º–∏, —Ç–æ Work Sample –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ–Ω, —Ä–∞—Å—á–µ—Ç –±—é–¥–∂–µ—Ç–∞ –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–æ–º.
    - –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Å–∏—Ç—É–∞—Ü–∏—é –¥–≤–∞–∂–¥—ã.

    *** –ß–ê–°–¢–¨ 1: SJT (–°–∏—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç) - 4 –í–æ–ø—Ä–æ—Å–∞ ***
    –ò–ù–°–¢–†–£–ö–¶–ò–Ø:
    1. –°—Ü–µ–Ω–∞—Ä–∏–π: 100-150 —Å–ª–æ–≤. –û–ø–∏—à–∏ –æ—Å—Ç—Ä—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è vs –õ–æ—è–ª—å–Ω–æ—Å—Ç—å" –∏–ª–∏ "–°—Ä–æ—á–Ω–æ—Å—Ç—å vs –†–µ–ø—É—Ç–∞—Ü–∏—è").
    2. –í–∞—Ä–∏–∞–Ω—Ç 2 –±–∞–ª–ª–∞: –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ, –º—É–¥—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—â–µ–µ —É—â–µ—Ä–±.
    3. –í–∞—Ä–∏–∞–Ω—Ç 1 –±–∞–ª–ª: –§–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º (—Å—É—Ö–æ, –±–µ–∑ —ç–º–ø–∞—Ç–∏–∏).
    4. –í–∞—Ä–∏–∞–Ω—Ç 0 –±–∞–ª–ª–æ–≤: –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è, –ø–µ—Ä–µ–≤–æ–¥ –≤–∏–Ω—ã, —É—Å—Ç—É–ø–∫–∞ –∑–∞ —Å—á–µ—Ç –±–∏–∑–Ω–µ—Å–∞).

    *** –ß–ê–°–¢–¨ 2: WORK SAMPLE (–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ö–µ–π—Å-–°—Ç–∞–¥–∏) - 1 –ó–∞–¥–∞–Ω–∏–µ ***
    –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –°–æ–∑–¥–∞–π —Å–ª–æ–∂–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é –ø–æ –º–µ—Ç–æ–¥—É "In-Basket" (–≤—Ö–æ–¥—è—â–∞—è –∑–∞–¥–∞—á–∞).
    –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–æ–µ –∑–∞–¥–∞–Ω–∏–µ (250+ —Å–ª–æ–≤).
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—è "text":
    "–ö–û–ù–¢–ï–ö–°–¢ –ò–°–¢–û–†–ò–ò: [–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è –Ω–∞ 150 —Å–ª–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏, –¥–∞—Ç–∞–º–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏].
    
    –í–•–û–î–Ø–©–ò–ï –î–ê–ù–ù–´–ï –ò –§–ê–ö–¢–´:
    - [–§–∞–∫—Ç 1: –ü—Ä–æ–±–ª–µ–º–∞ –≤ –¥–∞–Ω–Ω—ã—Ö/–º–µ—Ç—Ä–∏–∫–∞—Ö]
    - [–§–∞–∫—Ç 2: –ü—Ä—è–º–æ–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤]
    - [–§–∞–∫—Ç 3: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–µ–¥–æ–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–ª–ª–µ–≥–∏ –∏–ª–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è]
    
    –í–ê–®–ê –ó–ê–î–ê–ß–ê (–í–´–ü–û–õ–ù–ò–¢–ï –ü–û –ü–£–ù–ö–¢–ê–ú):
    1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ [X] –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞.
    2. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∫—Ä–∞—Ç–∫–∏–π –ø—Ä–æ–µ–∫—Ç —Ä–µ—à–µ–Ω–∏—è/—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è [Y].
    3. –û–±–æ—Å–Ω—É–π—Ç–µ –≤—ã–±–æ—Ä —Å–∞–º–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è."

    –§–û–†–ú–ê–¢ –í–´–î–ê–ß–ò (–¢–û–õ–¨–ö–û JSON):
    {
      "sjtQuestions": [
        { 
          "id": "1", 
          "text": "[–°—Ü–µ–Ω–∞—Ä–∏–π 1]", 
          "type": "scenario", 
          "options": [{ "id": "a", "text": "...", "value": 2 }, ...] 
        },
        ... (–≤—Å–µ–≥–æ 4)
      ],
      "workSampleQuestion": { 
        "id": "ws1", 
        "text": "[–î–õ–ò–ù–ù–´–ô –ò –°–õ–û–ñ–ù–´–ô –ö–ï–ô–°-–°–¢–ê–î–ò –°–û –í–°–ï–ú–ò –î–ê–ù–ù–´–ú–ò]", 
        "type": "text" 
      }
    }
  `;
  
  try {
    const jsonString = await callBackendAI(prompt, true);
    const cleanJson = jsonString.replace(/```json/g, "").replace(/```/g, "").trim();
    return JSON.parse(cleanJson);
  } catch (error) {
    console.error("Custom Question Gen Error:", error);
    throw error;
  }
};
